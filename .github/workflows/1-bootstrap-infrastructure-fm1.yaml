name: "ðŸš€ Bootstrap Infrastructure - fm1"

# ONE-TIME infrastructure setup
# Run this BEFORE any CI/CD workflows
# All operations are idempotent - safe to run multiple times

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "bootstrap" to confirm one-time infrastructure setup'
        required: true
        default: ''

env:
  APP_NAME: "fm1"
  TENANT: "opsera"
  AWS_REGION: "us-west-2"
  REGION_SHORT: "usw2"
  HUB_CLUSTER: "argocd-usw2"
  SPOKE_CLUSTER: "opsera-usw2-np"
  ECR_REPO_NAME: "opsera/fm1"

jobs:
  validate-confirmation:
    name: "Validate Bootstrap Confirmation"
    runs-on: ubuntu-latest
    steps:
      - name: Check Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "bootstrap" ]; then
            echo "âŒ Bootstrap not confirmed. Please type 'bootstrap' to proceed."
            exit 1
          fi
          echo "âœ… Bootstrap confirmed. Proceeding with infrastructure setup..."

  setup-ecr-repository:
    name: "ðŸ“¦ Setup ECR Repository"
    needs: [validate-confirmation]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create ECR Repository (Idempotent)
        run: |
          echo "Checking ECR repository: ${ECR_REPO_NAME}"

          # Check if repository exists
          if aws ecr describe-repositories --repository-names "${ECR_REPO_NAME}" 2>/dev/null; then
            echo "âœ… ECR repository already exists: ${ECR_REPO_NAME}"
            exit 0
          fi

          # Create repository with immutable tags
          echo "Creating ECR repository: ${ECR_REPO_NAME}"
          aws ecr create-repository \
            --repository-name "${ECR_REPO_NAME}" \
            --image-tag-mutability IMMUTABLE \
            --encryption-configuration encryptionType=AES256 \
            --tags Key=tenant,Value=${TENANT} \
                   Key=app,Value=${APP_NAME} \
                   Key=managed-by,Value=opsera-c2c

          echo "âœ… ECR repository created: ${ECR_REPO_NAME}"

      - name: Summary
        run: |
          echo "### ðŸ“¦ ECR Repository Setup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Repository: \`${ECR_REPO_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Region: \`${AWS_REGION}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Tag Mutability: IMMUTABLE" >> $GITHUB_STEP_SUMMARY
          echo "- Encryption: AES256" >> $GITHUB_STEP_SUMMARY

  register-repository-argocd:
    name: "ðŸ”— Register Repository with ArgoCD"
    needs: [validate-confirmation]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Kubeconfig (Hub)
        run: |
          aws eks update-kubeconfig \
            --name ${HUB_CLUSTER} \
            --region ${AWS_REGION} \
            --alias hub
          echo "âœ… Hub cluster kubeconfig configured"

      - name: Register GitHub Repository (Idempotent)
        run: |
          REPO_SECRET_NAME="repo-${{ github.repository_owner }}-${APP_NAME}"

          # Check if repository secret already exists (RULE 186)
          if kubectl --context hub get secret "$REPO_SECRET_NAME" -n argocd &>/dev/null; then
            echo "âœ… Repository secret already exists - skipping"
            exit 0
          fi

          echo "Creating repository secret in ArgoCD"
          cat <<EOF | kubectl --context hub apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: ${REPO_SECRET_NAME}
            namespace: argocd
            labels:
              argocd.argoproj.io/secret-type: repository
          type: Opaque
          stringData:
            type: git
            url: https://github.com/${{ github.repository }}.git
            password: ${{ secrets.GH_PAT }}
            username: git
          EOF

          echo "âœ… Repository registered with ArgoCD"

      - name: Summary
        run: |
          echo "### ðŸ”— Repository Registration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Repository: \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ArgoCD Hub: \`${HUB_CLUSTER}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Secret: \`repo-${{ github.repository_owner }}-${APP_NAME}\`" >> $GITHUB_STEP_SUMMARY

  register-spoke-cluster-argocd:
    name: "ðŸŽ¯ Register Spoke Cluster with ArgoCD"
    needs: [validate-confirmation]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Kubeconfig (Hub + Spoke)
        run: |
          # Hub cluster (where ArgoCD runs)
          aws eks update-kubeconfig \
            --name ${HUB_CLUSTER} \
            --region ${AWS_REGION} \
            --alias hub
          echo "âœ… Hub cluster kubeconfig configured"

          # Spoke cluster (where workloads run)
          aws eks update-kubeconfig \
            --name ${SPOKE_CLUSTER} \
            --region ${AWS_REGION} \
            --alias spoke
          echo "âœ… Spoke cluster kubeconfig configured"

      - name: Check Existing Registration (Idempotent)
        id: check
        run: |
          # CRITICAL: Use --context hub because argocd namespace is on hub (RULE 176, RULE 189)
          if kubectl --context hub get secret -n argocd cluster-${SPOKE_CLUSTER} 2>/dev/null; then
            echo "âœ… Spoke cluster already registered: ${SPOKE_CLUSTER}"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Spoke cluster not registered yet"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Register Spoke Cluster
        if: steps.check.outputs.exists == 'false'
        run: |
          echo "Registering spoke cluster with ArgoCD..."

          # Get spoke cluster details from AWS (NOT from kubeconfig alias)
          SPOKE_SERVER=$(aws eks describe-cluster \
            --name ${SPOKE_CLUSTER} \
            --region ${AWS_REGION} \
            --query 'cluster.endpoint' \
            --output text)

          SPOKE_CA=$(aws eks describe-cluster \
            --name ${SPOKE_CLUSTER} \
            --region ${AWS_REGION} \
            --query 'cluster.certificateAuthority.data' \
            --output text)

          # Validate cluster details
          if [ -z "$SPOKE_SERVER" ] || [ "$SPOKE_SERVER" = "None" ]; then
            echo "âŒ Failed to get spoke cluster endpoint"
            exit 1
          fi

          # Create service account token for ArgoCD (K8s 1.24+ compatible)
          kubectl --context spoke create serviceaccount argocd-manager \
            -n kube-system \
            --dry-run=client -o yaml | kubectl --context spoke apply -f -

          kubectl --context spoke create clusterrolebinding argocd-manager \
            --clusterrole=cluster-admin \
            --serviceaccount=kube-system:argocd-manager \
            --dry-run=client -o yaml | kubectl --context spoke apply -f -

          # Create token with 10-year expiration (multi-method for K8s compatibility)
          TOKEN=$(kubectl --context spoke create token argocd-manager \
            -n kube-system \
            --duration=87600h 2>/dev/null || \
            kubectl --context spoke get secret -n kube-system \
              $(kubectl --context spoke get sa argocd-manager -n kube-system \
                -o jsonpath='{.secrets[0].name}') \
              -o jsonpath='{.data.token}' | base64 -d)

          # Create cluster secret with kubectl apply (idempotent)
          cat <<EOF | kubectl --context hub apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: cluster-${SPOKE_CLUSTER}
            namespace: argocd
            labels:
              argocd.argoproj.io/secret-type: cluster
          type: Opaque
          stringData:
            name: "${SPOKE_CLUSTER}"
            server: "${SPOKE_SERVER}"
            config: |
              {
                "bearerToken": "${TOKEN}",
                "tlsClientConfig": {
                  "insecure": false,
                  "caData": "${SPOKE_CA}"
                }
              }
          EOF

          echo "âœ… Spoke cluster registered with ArgoCD: ${SPOKE_CLUSTER}"

      - name: Summary
        run: |
          echo "### ðŸŽ¯ Spoke Cluster Registration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Spoke Cluster: \`${SPOKE_CLUSTER}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Hub Cluster: \`${HUB_CLUSTER}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Service Account: \`argocd-manager\`" >> $GITHUB_STEP_SUMMARY

  create-folder-structure:
    name: "ðŸ“ Create Folder Structure"
    needs: [validate-confirmation]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Directory Structure (Idempotent)
        run: |
          # RULE 183: TENANT defaults to "opsera" for backwards compatibility
          TENANT=${TENANT:-opsera}

          # RULE 177: Ensure directories exist BEFORE verifying
          echo "Creating .${TENANT}-${APP_NAME} folder structure..."

          mkdir -p .${TENANT}-${APP_NAME}/k8s/base
          mkdir -p .${TENANT}-${APP_NAME}/k8s/overlays/dev
          mkdir -p .${TENANT}-${APP_NAME}/argocd/dev

          echo "âœ… Folder structure created (tenant: ${TENANT})"

          # Verify structure
          if test -d .${TENANT}-${APP_NAME}/k8s/base && \
             test -d .${TENANT}-${APP_NAME}/k8s/overlays/dev && \
             test -d .${TENANT}-${APP_NAME}/argocd/dev; then
            echo "âœ… Folder structure verified"
          else
            echo "âŒ Folder structure verification failed"
            exit 1
          fi

          # Create .gitkeep files to preserve structure
          touch .${TENANT}-${APP_NAME}/k8s/base/.gitkeep
          touch .${TENANT}-${APP_NAME}/k8s/overlays/dev/.gitkeep
          touch .${TENANT}-${APP_NAME}/argocd/dev/.gitkeep

      - name: Commit Folder Structure
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .${TENANT}-${APP_NAME}/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(bootstrap): create folder structure for fm1 [skip ci]"
            git push origin ${{ github.ref_name }}
            echo "âœ… Folder structure committed"
          fi

      - name: Summary
        run: |
          echo "### ðŸ“ Folder Structure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo ".${TENANT}-${APP_NAME}/" >> $GITHUB_STEP_SUMMARY
          echo "â”œâ”€â”€ k8s/" >> $GITHUB_STEP_SUMMARY
          echo "â”‚   â”œâ”€â”€ base/" >> $GITHUB_STEP_SUMMARY
          echo "â”‚   â””â”€â”€ overlays/" >> $GITHUB_STEP_SUMMARY
          echo "â”‚       â””â”€â”€ dev/" >> $GITHUB_STEP_SUMMARY
          echo "â””â”€â”€ argocd/" >> $GITHUB_STEP_SUMMARY
          echo "    â””â”€â”€ dev/" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  create-namespaces:
    name: "ðŸ·ï¸ Create Namespaces"
    needs: [validate-confirmation]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Kubeconfig (Spoke)
        run: |
          aws eks update-kubeconfig \
            --name ${SPOKE_CLUSTER} \
            --region ${AWS_REGION} \
            --alias spoke
          echo "âœ… Spoke cluster kubeconfig configured"

      - name: Create Namespace (Idempotent)
        run: |
          ENV="dev"
          NAMESPACE="${TENANT}-${APP_NAME}-${ENV}"

          # Check if namespace exists
          if kubectl --context spoke get namespace ${NAMESPACE} 2>/dev/null; then
            echo "âœ… Namespace already exists: ${NAMESPACE}"
          else
            echo "Creating namespace: ${NAMESPACE}"
            kubectl --context spoke create namespace ${NAMESPACE}
            kubectl --context spoke label namespace ${NAMESPACE} \
              tenant=${TENANT} \
              app=${APP_NAME} \
              environment=${ENV} \
              managed-by=opsera-c2c
            echo "âœ… Namespace created: ${NAMESPACE}"
          fi

      - name: Summary
        run: |
          echo "### ðŸ·ï¸ Namespaces Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`${TENANT}-${APP_NAME}-dev\`" >> $GITHUB_STEP_SUMMARY

  create-service-accounts:
    name: "ðŸ‘¤ Create Service Accounts"
    needs: [create-namespaces]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Kubeconfig (Spoke)
        run: |
          aws eks update-kubeconfig \
            --name ${SPOKE_CLUSTER} \
            --region ${AWS_REGION} \
            --alias spoke
          echo "âœ… Spoke cluster kubeconfig configured"

      - name: Create Service Account (Idempotent)
        run: |
          ENV="dev"
          NAMESPACE="${TENANT}-${APP_NAME}-${ENV}"
          SA_NAME="${APP_NAME}-sa"

          # Check if service account exists
          if kubectl --context spoke get sa ${SA_NAME} -n ${NAMESPACE} 2>/dev/null; then
            echo "âœ… Service account already exists: ${SA_NAME}"
          else
            echo "Creating service account: ${SA_NAME}"
            kubectl --context spoke create serviceaccount ${SA_NAME} -n ${NAMESPACE}
            echo "âœ… Service account created: ${SA_NAME}"
          fi

      - name: Summary
        run: |
          echo "### ðŸ‘¤ Service Accounts Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`${APP_NAME}-sa\` in \`${TENANT}-${APP_NAME}-dev\`" >> $GITHUB_STEP_SUMMARY

  bootstrap-complete:
    name: "âœ… Bootstrap Complete"
    needs: [
      setup-ecr-repository,
      register-repository-argocd,
      register-spoke-cluster-argocd,
      create-folder-structure,
      create-namespaces,
      create-service-accounts
    ]
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "# ðŸŽ‰ Bootstrap Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Infrastructure setup completed successfully for **${APP_NAME}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify all resources were created" >> $GITHUB_STEP_SUMMARY
          echo "2. Trigger CI/CD workflow for dev environment:" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   gh workflow run \"2-ci-build-scan-push-${APP_NAME}-dev.yaml\"" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor deployment progress" >> $GITHUB_STEP_SUMMARY
          echo "4. Verify application health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Resources Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ECR Repository: \`${ECR_REPO_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ArgoCD Repository Registration" >> $GITHUB_STEP_SUMMARY
          echo "- Spoke Cluster Registration: \`${SPOKE_CLUSTER}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Namespace: \`${TENANT}-${APP_NAME}-dev\`" >> $GITHUB_STEP_SUMMARY
          echo "- Service Account: \`${APP_NAME}-sa\`" >> $GITHUB_STEP_SUMMARY
          echo "- Folder Structure: \`.${TENANT}-${APP_NAME}/\`" >> $GITHUB_STEP_SUMMARY
