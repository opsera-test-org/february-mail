name: "Deployment Landscape - fbb11"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to generate landscape for'
        required: true
        type: choice
        options:
          - dev
          - qa
          - staging
          - prod
          - all

  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'

env:
  APP_NAME: fbb11
  TENANT: opsera
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np

permissions:
  contents: write
  id-token: write

jobs:
  generate-landscape:
    name: "ðŸ“Š Generate Landscape - ${{ inputs.environment || 'all' }}"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ${{ inputs.environment == 'all' && fromJson('["dev", "qa", "staging", "prod"]') || fromJson(format('["{0}"]', inputs.environment || 'dev')) }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure kubeconfig for spoke cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }} --alias spoke

      - name: Check environment exists
        id: check_env
        run: |
          NAMESPACE="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ matrix.environment }}"
          if kubectl --context spoke get namespace ${NAMESPACE} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ“ Environment exists: ${{ matrix.environment }}"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Environment does not exist: ${{ matrix.environment }}"
          fi

      - name: Collect deployment data
        if: steps.check_env.outputs.exists == 'true'
        id: collect
        run: |
          NAMESPACE="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ matrix.environment }}"

          # Pods
          echo "## Pods" > /tmp/landscape-${{ matrix.environment }}.md
          kubectl --context spoke get pods -n ${NAMESPACE} -o wide >> /tmp/landscape-${{ matrix.environment }}.md

          # Services
          echo "" >> /tmp/landscape-${{ matrix.environment }}.md
          echo "## Services" >> /tmp/landscape-${{ matrix.environment }}.md
          kubectl --context spoke get svc -n ${NAMESPACE }} >> /tmp/landscape-${{ matrix.environment }}.md

          # Ingress
          echo "" >> /tmp/landscape-${{ matrix.environment }}.md
          echo "## Ingress" >> /tmp/landscape-${{ matrix.environment }}.md
          kubectl --context spoke get ingress -n ${NAMESPACE} >> /tmp/landscape-${{ matrix.environment }}.md

          # Deployments
          echo "" >> /tmp/landscape-${{ matrix.environment }}.md
          echo "## Deployments" >> /tmp/landscape-${{ matrix.environment }}.md
          kubectl --context spoke get deployments -n ${NAMESPACE} -o wide >> /tmp/landscape-${{ matrix.environment }}.md

          # Recent Events
          echo "" >> /tmp/landscape-${{ matrix.environment }}.md
          echo "## Recent Events (Last 10)" >> /tmp/landscape-${{ matrix.environment }}.md
          kubectl --context spoke get events -n ${NAMESPACE} --sort-by='.lastTimestamp' | tail -10 >> /tmp/landscape-${{ matrix.environment }}.md

          echo "âœ… Landscape data collected for ${{ matrix.environment }}"

      - name: Generate LANDSCAPE.md
        if: steps.check_env.outputs.exists == 'true'
        run: |
          NAMESPACE="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ matrix.environment }}"
          LANDSCAPE_DIR=".opsera-${{ env.APP_NAME }}/landscapes/${{ matrix.environment }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          mkdir -p ${LANDSCAPE_DIR}

          cat > ${LANDSCAPE_DIR}/LANDSCAPE.md <<'EOF'
          # Deployment Landscape - fbb11 (${{ matrix.environment }})

          **Generated**: ${TIMESTAMP}
          **Namespace**: ${NAMESPACE}
          **Cluster**: ${{ env.SPOKE_CLUSTER }}
          **Region**: ${{ env.AWS_REGION }}

          ---

          EOF

          cat /tmp/landscape-${{ matrix.environment }}.md >> ${LANDSCAPE_DIR}/LANDSCAPE.md

          echo "âœ… LANDSCAPE.md generated"

      - name: Create deployment manifest entry
        if: steps.check_env.outputs.exists == 'true'
        run: |
          MANIFEST_FILE=".opsera-${{ env.APP_NAME }}/landscapes/deployments-manifest.json"

          # Initialize if doesn't exist
          [ ! -f ${MANIFEST_FILE} ] && echo "[]" > ${MANIFEST_FILE}

          # Create new entry
          NEW_ENTRY=$(cat <<EOF
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "environment": "${{ matrix.environment }}",
            "namespace": "${{ env.TENANT }}-${{ env.APP_NAME }}-${{ matrix.environment }}",
            "cluster": "${{ env.SPOKE_CLUSTER }}",
            "region": "${{ env.AWS_REGION }}",
            "commit": "${{ github.sha }}",
            "workflow_run": "${{ github.run_id }}",
            "status": "success"
          }
          EOF
          )

          # Prepend new entry and cap at 50
          jq --argjson new_entry "$NEW_ENTRY" '. = [$new_entry] + . | .[0:50]' ${MANIFEST_FILE} > /tmp/manifest.json
          mv /tmp/manifest.json ${MANIFEST_FILE}

          echo "âœ… Deployment manifest updated"

      - name: Commit landscape files
        if: steps.check_env.outputs.exists == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Pull first before making changes
          git pull --rebase origin ${{ github.ref_name }}

          git add .opsera-${{ env.APP_NAME }}/landscapes/

          if git diff --staged --quiet; then
            echo "No landscape changes to commit"
            exit 0
          fi

          git commit -m "chore(landscape): update ${{ matrix.environment }} landscape [skip ci]"

          # Retry loop for push with conflict resolution
          for i in 1 2 3; do
            echo "Push attempt $i/3..."
            if git push origin ${{ github.ref_name }}; then
              echo "âœ… Landscape committed and pushed successfully"
              break
            fi

            echo "âš ï¸ Push failed, pulling latest and retrying..."
            git pull --rebase origin ${{ github.ref_name }}
            sleep 2

            if [ $i -eq 3 ]; then
              echo "âŒ Failed to push after 3 attempts"
              exit 1
            fi
          done

  landscape-summary:
    name: "ðŸ“‹ Landscape Summary"
    runs-on: ubuntu-latest
    needs: [generate-landscape]
    if: always()
    steps:
      - name: Display summary
        run: |
          echo "# Deployment Landscape Summary - fbb11" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Generated Landscapes" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ needs.generate-landscape.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## View Landscapes" >> $GITHUB_STEP_SUMMARY
          echo "Navigate to \`.opsera-fbb11/landscapes/\` directory to view generated landscapes" >> $GITHUB_STEP_SUMMARY
